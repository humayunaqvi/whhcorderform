<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>West Houston Heart Center - Order System</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; color: #333; background: #f5f5f5; }
    
    /* Login Page Styles */
    #login-page { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #login-page h1 { text-align: center; color: #c00; margin-bottom: 20px; }
    #login-page label { display: block; margin: 15px 0 5px; font-weight: bold; }
    #login-page input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    #login-page button { width: 100%; padding: 12px; background: #c00; color: #fff; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    #login-page button:hover { background: #a00; }
    .login-error { color: #c00; margin-top: 10px; text-align: center; display: none; }
    
    /* Admin Form Styles */
    #admin-view { display: none; max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #admin-view h1 { text-align: center; color: #c00; margin-bottom: 10px; }
    .logout-btn { float: right; padding: 8px 15px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
    .logout-btn:hover { background: #555; }
    form { margin-top: 20px; }
    label { display: flex; align-items: center; margin: 6px 0; }
    label > input, label > textarea, label > select { margin-left: 8px; flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    label > input[type="checkbox"] { margin-left: 0; margin-right: 8px; flex: 0 0 auto; width: auto; }
    #categories fieldset { margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    #categories div { display: flex; align-items: center; margin: 6px 0; }
    #categories div input[type="checkbox"] { margin-right: 8px; }
    #categories div input[type="number"],
    #categories div select,
    #categories div input[type="text"] { margin-left: auto; width: 100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    button[type="submit"] { width: 100%; padding: 10px; background: #c00; color: #fff; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    button[type="submit"]:hover { background: #a00; }
    .status-message { margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 14px; display: none; }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    /* Task Tracker Dashboard Styles */
    #tracker-view { display: none; max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #tracker-view h1 { text-align: center; color: #c00; margin-bottom: 20px; }
    
    /* Staff Dashboard Styles */
    #staff-view { display: none; max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #staff-view h1 { text-align: center; color: #0066cc; margin-bottom: 20px; }
    .date-filter { text-align: center; margin-bottom: 20px; }
    .date-filter input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .task-card { background: #f5f5f5; border: 2px solid #0066cc; border-radius: 6px; padding: 15px; margin-bottom: 15px; }
    .task-header { background: #0066cc; color: #fff; padding: 10px; border-radius: 4px 4px 0 0; margin: -15px -15px 10px -15px; font-weight: bold; }
    .task-item { padding: 8px; margin: 5px 0; background: white; border-left: 4px solid #0066cc; border-radius: 4px; display: flex; align-items: flex-start; }
    .task-item input[type="checkbox"] { margin-right: 10px; margin-top: 3px; width: 18px; height: 18px; cursor: pointer; }
    .task-item.completed { opacity: 0.6; text-decoration: line-through; }
    .task-category { font-weight: bold; color: #0066cc; margin-bottom: 3px; font-size: 13px; }
    .task-details { font-size: 12px; color: #666; margin-left: 28px; }
    .no-tasks { text-align: center; padding: 40px; color: #666; font-size: 16px; }
    
    /* Admin Dashboard Styles */
    .admin-dashboard { margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 2px solid #c00; }
    .admin-dashboard h2 { color: #c00; margin-top: 0; margin-bottom: 15px; text-align: center; }
    .dashboard-controls { text-align: center; margin-bottom: 20px; }
    .dashboard-controls input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; margin-right: 10px; }
    .dashboard-controls button { padding: 8px 15px; background: #c00; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .dashboard-controls button:hover { background: #a00; }
    .stats-container { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px; }
    .stats-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 150px; text-align: center; }
    .stats-box h3 { margin: 0 0 10px 0; color: #666; font-size: 14px; }
    .stats-box .number { font-size: 32px; font-weight: bold; margin: 10px 0; }
    .stats-box .completed { color: #28a745; }
    .stats-box .pending { color: #ffc107; }
    .stats-box .total { color: #0066cc; }
    .pie-chart-container { width: 250px; height: 250px; margin: 0 auto; }
    .pie-chart-svg { width: 100%; height: 100%; }
    .chart-legend { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .legend-color { width: 20px; height: 20px; border-radius: 4px; }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body { padding: 5px; font-size: 16px; }
      * { box-sizing: border-box; }
      
      /* Ensure all buttons and inputs are properly sized */
      button, input, select, textarea { 
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }
      
      /* Login Page Mobile */
      #login-page { max-width: 100%; margin: 20px auto; padding: 20px 15px; }
      #login-page h1 { font-size: 24px; margin-bottom: 15px; }
      #login-page h2 { font-size: 16px; }
      #login-page input { font-size: 16px; padding: 12px; }
      #login-page button { font-size: 18px; padding: 14px; }
      
      /* Admin View Mobile */
      #admin-view { max-width: 100%; padding: 15px 10px; margin: 0; }
      #admin-view h1 { font-size: 22px; margin-bottom: 15px; text-align: center; }
      .logout-btn { float: none; display: block; width: 100%; margin-bottom: 15px; padding: 12px; font-size: 16px; }
      form { margin-top: 15px; }
      label { flex-direction: column; align-items: flex-start; margin: 10px 0; display: flex; }
      label > input, label > textarea, label > select { margin-left: 0; margin-top: 5px; width: 100%; font-size: 16px; padding: 10px; box-sizing: border-box; }
      label > input[type="checkbox"] { margin-right: 8px; margin-top: 0; width: 20px; height: 20px; flex-shrink: 0; }
      #categories fieldset { padding: 10px; margin-bottom: 15px; }
      #categories div { flex-direction: column; align-items: flex-start; margin: 8px 0; }
      #categories div input[type="number"], 
      #categories div select, 
      #categories div input[type="text"] { margin: 8px 0 0 0; width: 100%; font-size: 16px; padding: 10px; }
      button[type="submit"] { font-size: 18px; padding: 14px; margin-top: 15px; }
      
      /* Staff Dashboard Mobile */
      #staff-view { max-width: 100%; padding: 15px 10px; margin: 0; }
      #staff-view h1 { font-size: 22px; text-align: center; }
      .date-filter { margin-bottom: 15px; text-align: left; }
      .date-filter label { display: block; width: 100%; margin-bottom: 10px; flex-direction: column; align-items: flex-start; }
      .date-filter label > input { margin-left: 0; margin-top: 5px; width: 100%; }
      .date-filter input { font-size: 16px; padding: 10px; width: 100%; margin-bottom: 10px; display: block; }
      .date-filter button { width: 100%; padding: 12px; font-size: 16px; margin: 5px 0; display: block; }
      .print-btn, .download-btn { 
        width: 100% !important; 
        padding: 12px !important; 
        font-size: 16px !important; 
        margin: 8px 0 !important; 
        margin-left: 0 !important;
        display: block !important;
        box-sizing: border-box !important;
      }
      .task-card { padding: 12px; margin-bottom: 12px; }
      .task-header { padding: 12px; font-size: 14px; }
      .task-item { padding: 10px; margin: 8px 0; display: flex; align-items: flex-start; }
      .task-item input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; flex-shrink: 0; margin-top: 3px; }
      .task-category { font-size: 14px; display: block; }
      .task-details { font-size: 13px; margin-left: 0; display: block; }
      
      /* Tracker Dashboard Mobile */
      #tracker-view { max-width: 100%; padding: 15px 10px; margin: 0; }
      #tracker-view h1 { font-size: 22px; text-align: center; }
      .dashboard-controls { margin-bottom: 15px; text-align: left; }
      .dashboard-controls label { display: block; width: 100%; margin-bottom: 10px; flex-direction: column; align-items: flex-start; }
      .dashboard-controls label > input { margin-left: 0; margin-top: 5px; width: 100%; }
      .dashboard-controls input { font-size: 16px; padding: 10px; width: 100%; margin-bottom: 10px; display: block; }
      .dashboard-controls button { width: 100%; padding: 12px; font-size: 16px; margin: 8px 0; display: block; }
      .stats-container { flex-direction: column; gap: 15px; }
      .stats-box { width: 100%; min-width: auto; }
      .pie-chart-container { width: 200px; height: 200px; }
      
      /* User Management Mobile */
      #user-management-section { padding: 15px; margin: 15px 0; }
      #user-management-section h2 { text-align: center; }
      #user-management-section button { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 10px; display: block; box-sizing: border-box; }
      #user-management-content { margin-top: 15px; }
      #user-management-content h3 { text-align: left; }
      #user-management-content input { font-size: 16px; padding: 10px; width: 100%; margin-bottom: 10px; display: block; box-sizing: border-box; }
      #user-management-content button { width: 100%; padding: 12px; font-size: 16px; display: block; box-sizing: border-box; margin: 5px 0; }
      #user-management-content > div { display: flex; flex-direction: column; gap: 10px; }
      #user-management-content > div > div { display: flex; flex-direction: column; gap: 10px; }
      
      /* Task Checklist Management Mobile */
      #tracker-tasks-container .task-card { padding: 12px; }
      #tracker-tasks-container .task-header { padding: 12px; font-size: 14px; text-align: center; }
      #tracker-tasks-container .task-item { padding: 10px; display: flex; align-items: flex-start; }
      #tracker-tasks-container .task-item input[type="checkbox"] { width: 22px; height: 22px; flex-shrink: 0; margin-right: 12px; margin-top: 3px; }
      #tracker-tasks-container .task-category { display: block; }
      #tracker-tasks-container .task-details { margin-left: 0; display: block; }
    }
    
    /* Extra Small Devices (phones in portrait) */
    @media (max-width: 480px) {
      body { padding: 3px; }
      #login-page { padding: 15px 10px; }
      #admin-view, #staff-view, #tracker-view { padding: 10px 5px; }
      #admin-view h1, #staff-view h1, #tracker-view h1 { font-size: 20px; }
      .task-header { font-size: 13px; padding: 10px; }
      .stats-box { padding: 12px; }
      .stats-box .number { font-size: 28px; }
    }
    
    /* Touch-friendly elements */
    @media (hover: none) and (pointer: coarse) {
      button, input[type="button"], input[type="submit"], .logout-btn { 
        min-height: 44px; 
        min-width: 44px;
      }
      input[type="checkbox"] { 
        min-width: 22px; 
        min-height: 22px; 
      }
      label { 
        min-height: 44px; 
        padding: 5px 0;
      }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="login-page">
    <h1>West Houston Heart Center</h1>
    <h2 style="text-align: center; font-size: 18px; margin-bottom: 20px;">Order System</h2>
    <form id="login-form">
      <label>Username:</label>
      <input type="text" id="username" required autocomplete="username">
      <label>Password:</label>
      <input type="password" id="password" required autocomplete="current-password">
      <button type="submit">Login</button>
      <div class="login-error" id="login-error">Invalid username or password</div>
    </form>
  </div>

  <!-- Admin View (Order Form) -->
  <div id="admin-view">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h1>Clinic Visit - Order Form</h1>
    <form id="order-form">
      <label>Patient Name:<input type="text" id="patient-name" required></label>
      <label>Date of Service:<input type="date" id="dos" readonly></label>
      <div id="categories"></div>
      <label>Follow-up visit:<input type="text" id="followup" placeholder="e.g., 2 weeks"></label>
      <label>Refer to:<input type="text" id="referto" placeholder="Doctor name & specialty"></label>
      <label><input type="checkbox" id="pcp"> Update PCP information</label>
      <label><input type="checkbox" id="mediterranean-diet"> Give Mediterranean Diet Info</label>
      <label><input type="checkbox" id="exercise-regimen"> Give Exercise Regimen Info</label>
      <label>Instructions for Patient:<textarea id="instructions" rows="4" placeholder="Enter any additional instructions..."></textarea></label>
      <button type="submit">Generate Print Page & Save Task</button>
    </form>
    <div class="status-message" id="status-message"></div>
  </div>

  <!-- Task Tracker View (Monitoring Dashboard) -->
  <div id="tracker-view">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h1>Task Monitoring Dashboard</h1>
    
    <!-- User Management Section (only for tracker role) -->
    <div id="user-management-section" style="margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 2px solid #0066cc;">
      <h2 style="color: #0066cc; margin-top: 0; margin-bottom: 15px; text-align: center;">User Management</h2>
      <button onclick="toggleUserManagement()" style="padding: 8px 15px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-bottom: 15px;">Manage Staff Accounts</button>
      <div id="user-management-content" style="display: none;">
        <div id="staff-users-list"></div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
          <h3 style="color: #0066cc; margin-bottom: 10px;">Add New Staff User</h3>
          <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
              <input type="text" id="new-staff-username" placeholder="Enter username" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
              <input type="password" id="new-staff-password" placeholder="Enter password" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
            </div>
            <button onclick="addStaffUser()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Add Staff User</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="dashboard-controls">
      <label>View statistics for date: <input type="date" id="tracker-date-filter"></label>
      <button onclick="updateTrackerDashboard()">Update Statistics</button>
    </div>
    <div id="tracker-dashboard-content">
      <!-- Statistics and pie chart will be inserted here -->
    </div>
    
    <!-- Task Checklist Management Section -->
    <div style="margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 2px solid #0066cc;">
      <h2 style="color: #0066cc; margin-top: 0; margin-bottom: 15px; text-align: center;">Task Checklist Management</h2>
      <div class="dashboard-controls">
        <label>View tasks for date: <input type="date" id="tracker-task-date-filter"></label>
        <button onclick="loadTrackerTasks()">Load Tasks</button>
      </div>
      <div id="tracker-tasks-container">
        <!-- Task list will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Staff View (Task Dashboard) -->
  <div id="staff-view">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h1>Staff Task Dashboard</h1>
    <div class="date-filter">
      <label>View tasks for date: <input type="date" id="task-date-filter"></label>
      <button class="print-btn" onclick="printAllTasks()" style="margin-left: 15px; padding: 8px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Print/Save All Tasks as PDF</button>
      <button class="download-btn" onclick="downloadAllTasks()" style="margin-left: 10px; padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Download as HTML File</button>
    </div>
    <div id="tasks-container"></div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD1TVMfNmh1kONRsXRSW_hyuqgvT4eqfxg",
      authDomain: "whhcorderform.firebaseapp.com",
      databaseURL: "https://whhcorderform-default-rtdb.firebaseio.com",
      projectId: "whhcorderform",
      storageBucket: "whhcorderform.firebasestorage.app",
      messagingSenderId: "998553620096",
      appId: "1:998553620096:web:ffd5ab75680d61d7cf6065"
    };
    
    // Initialize Firebase (with fallback to localStorage if not configured)
    let database = null;
    let useFirebase = false;
    
    // Initialize Firebase - wait for scripts to load
    function initializeFirebase() {
      try {
        // Check if Firebase is loaded and config is valid
        if (typeof firebase !== 'undefined' && 
            firebaseConfig.apiKey && 
            firebaseConfig.apiKey !== "YOUR_API_KEY" &&
            firebaseConfig.databaseURL) {
          firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          useFirebase = true;
          console.log('âœ… Firebase initialized successfully');
        } else {
          if (typeof firebase === 'undefined') {
            console.warn('âš ï¸ Firebase SDK not loaded. Check if scripts are loading correctly. Using localStorage fallback.');
          } else if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.warn('âš ï¸ Firebase API key not configured. Using localStorage fallback.');
          } else {
            console.warn('âš ï¸ Firebase configuration incomplete. Using localStorage fallback.');
          }
        }
      } catch (error) {
        console.error('âŒ Firebase initialization error:', error);
        console.warn('Falling back to localStorage');
      }
    }
    
    // Wait for Firebase scripts to load
    function tryInitializeFirebase() {
      console.log('Checking Firebase availability...', typeof firebase);
      console.log('Firebase config:', firebaseConfig.apiKey ? 'API key present' : 'API key missing');
      
      if (typeof firebase !== 'undefined') {
        // Firebase already loaded
        initializeFirebase();
      } else {
        // Wait for window load event, then try again
        if (document.readyState === 'complete') {
          // Page already loaded, wait a bit more for scripts
          setTimeout(function() {
            if (typeof firebase !== 'undefined') {
              initializeFirebase();
            } else {
              console.warn('âš ï¸ Firebase SDK failed to load after page load. Using localStorage fallback.');
            }
          }, 500);
        } else {
          window.addEventListener('load', function() {
            setTimeout(function() {
              if (typeof firebase !== 'undefined') {
                initializeFirebase();
              } else {
                console.warn('âš ï¸ Firebase SDK failed to load. Using localStorage fallback.');
              }
            }, 500);
          });
        }
      }
    }
    
    tryInitializeFirebase();
    
    // Authentication and User Management
    const USERS_KEY = 'whhc_users';
    const TASKS_KEY = 'whhc_tasks';
    const SESSION_KEY = 'whhc_session';
    
    // Store event handler references to prevent duplicates
    let staffCheckboxHandler = null;
    let trackerCheckboxHandler = null;
    
    // Firebase real-time listeners
    let tasksListener = null;
    let usersListener = null;
    
    // Initialize default admin user if not exists
    function initUsers() {
      if (!localStorage.getItem(USERS_KEY)) {
        const defaultUsers = {
          'hnaqvi': { password: 'Whhc1140!!', role: 'admin' },
          'whhcadmin': { password: 'Whhc11421!!', role: 'tracker' },
          'whhcclinical': { password: 'clinical123', role: 'clinical' },
          'staff1': { password: 'staff123', role: 'staff' },
          'staff2': { password: 'staff123', role: 'staff' }
        };
        localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
      } else {
        // Update existing admin credentials if they exist
        const users = JSON.parse(localStorage.getItem(USERS_KEY));
        // Remove old admin user if it exists
        if (users['admin']) {
          delete users['admin'];
        }
        // Add or update hnaqvi admin user
        users['hnaqvi'] = { password: 'Whhc1140!!', role: 'admin' };
        // Remove old tasktracker user if exists
        if (users['tasktracker']) {
          delete users['tasktracker'];
        }
        // Add or update whhcadmin user
        users['whhcadmin'] = { password: 'Whhc11421!!', role: 'tracker' };
        // Add or update whhcclinical user
        users['whhcclinical'] = { password: 'clinical123', role: 'clinical' };
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
      }
    }
    
    // Simple password hash (for basic security - not production-grade)
    function hashPassword(pwd) {
      let hash = 0;
      for (let i = 0; i < pwd.length; i++) {
        const char = pwd.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString();
    }
    
    // Login function
    function login(username, password) {
      const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
      const user = users[username];
      
      if (user && user.password === password) {
        const session = { username, role: user.role, timestamp: Date.now() };
        localStorage.setItem(SESSION_KEY, JSON.stringify(session));
        return true;
      }
      return false;
    }
    
    // Check if user is logged in
    function checkSession() {
      const sessionStr = localStorage.getItem(SESSION_KEY);
      if (!sessionStr) return null;
      
      const session = JSON.parse(sessionStr);
      // Session expires after 8 hours
      if (Date.now() - session.timestamp > 8 * 60 * 60 * 1000) {
        localStorage.removeItem(SESSION_KEY);
        return null;
      }
      return session;
    }
    
    // Logout function
    function logout() {
      localStorage.removeItem(SESSION_KEY);
      showLoginPage();
    }
    
    // Show appropriate view based on role
    function showView() {
      const session = checkSession();
      if (!session) {
        showLoginPage();
        return;
      }
      
      document.getElementById('login-page').style.display = 'none';
      
      if (session.role === 'admin') {
        document.getElementById('admin-view').style.display = 'block';
        document.getElementById('staff-view').style.display = 'none';
        document.getElementById('tracker-view').style.display = 'none';
        initAdminForm();
      } else if (session.role === 'tracker' || session.role === 'clinical') {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('staff-view').style.display = 'none';
        document.getElementById('tracker-view').style.display = 'block';
        initTrackerDashboard(session.role);
      } else {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('staff-view').style.display = 'block';
        document.getElementById('tracker-view').style.display = 'none';
        initStaffDashboard();
      }
    }
    
    function showLoginPage() {
      document.getElementById('login-page').style.display = 'block';
      document.getElementById('admin-view').style.display = 'none';
      document.getElementById('staff-view').style.display = 'none';
      document.getElementById('tracker-view').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }
    
    // Login form handler
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (login(username, password)) {
        errorDiv.style.display = 'none';
        showView();
      } else {
        errorDiv.style.display = 'block';
      }
    });
    
    // Save task to Firebase or localStorage
    let taskCounter = 0;
    function saveTask(taskData) {
      // Generate unique ID with timestamp, counter, and random component to prevent collisions
      const uniqueId = Date.now().toString() + '-' + (taskCounter++).toString().padStart(4, '0') + '-' + Math.random().toString(36).substr(2, 5);
      const task = {
        id: uniqueId,
        ...taskData,
        createdAt: new Date().toISOString(),
        completed: false
      };
      
      if (useFirebase && database) {
        // Save to Firebase Realtime Database
        database.ref('tasks/' + task.id).set(task)
          .catch(error => {
            console.error('Error saving task:', error);
            alert('Error saving task. Please try again.');
          });
      } else {
        // Fallback to localStorage
        const tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
        tasks.push(task);
        localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
      }
    }
    
    // Get tasks for a specific date (synchronous version for immediate use)
    // Get tasks for a specific date (synchronous version - returns cached data)
    let cachedTasks = {};
    function getTasksForDate(dateStr) {
      if (useFirebase) {
        return cachedTasks[dateStr] || [];
      } else {
        // Fallback to localStorage
        const tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
        return tasks.filter(task => task.dateOfService === dateStr);
      }
    }
    
    // Get tasks for a specific date from Firebase (async)
    function getTasksForDateAsync(dateStr, callback) {
      if (useFirebase && database) {
        database.ref('tasks').orderByChild('dateOfService').equalTo(dateStr).once('value')
          .then(snapshot => {
            const tasks = [];
            snapshot.forEach(child => {
              tasks.push(child.val());
            });
            cachedTasks[dateStr] = tasks;
            callback(tasks);
          })
          .catch(error => {
            console.error('Error fetching tasks:', error);
            callback([]);
          });
      } else {
        // Fallback to localStorage
        const tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
        const filteredTasks = tasks.filter(task => task.dateOfService === dateStr);
        callback(filteredTasks);
      }
    }
    
    // Set up real-time listener for tasks
    function setupTasksListener(dateStr, callback) {
      if (useFirebase && database) {
        // Remove existing listener if any
        if (tasksListener) {
          database.ref('tasks').off('value', tasksListener);
        }
        
        // Set up new listener
        tasksListener = database.ref('tasks')
          .orderByChild('dateOfService')
          .equalTo(dateStr)
          .on('value', snapshot => {
            const tasks = [];
            snapshot.forEach(child => {
              tasks.push(child.val());
            });
            cachedTasks[dateStr] = tasks;
            callback(tasks);
          });
      } else {
        // Fallback: just load once from localStorage
        getTasksForDateAsync(dateStr, callback);
      }
    }
    
    // Get all tasks (for admin dashboard)
    function getAllTasks() {
      return JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
    }
    
    // Calculate task statistics for a date
    function calculateTaskStats(dateStr, callback) {
      getTasksForDateAsync(dateStr, (tasks) => {
        const total = tasks.length;
        const completed = tasks.filter(t => t.completed).length;
        const pending = total - completed;
        callback({ total, completed, pending });
      });
    }
    
    // Create SVG pie chart
    function createPieChart(completed, pending, containerId) {
      const total = completed + pending;
      if (total === 0) {
        document.getElementById(containerId).innerHTML = '<p style="text-align:center;color:#666;padding:50px;">No tasks for this date</p>';
        return;
      }
      
      const radius = 80;
      const centerX = 125;
      const centerY = 125;
      const circumference = 2 * Math.PI * radius;
      
      const completedPercent = total > 0 ? (completed / total) : 0;
      const pendingPercent = total > 0 ? (pending / total) : 0;
      
      let svg = `<svg class="pie-chart-svg" viewBox="0 0 250 250">`;
      
      // Completed slice (green) - starts from top (-90 degrees)
      if (completed > 0) {
        const completedLength = completedPercent * circumference;
        const completedOffset = circumference - completedLength;
        svg += `<circle cx="${centerX}" cy="${centerY}" r="${radius}" fill="none" stroke="#28a745" stroke-width="40" 
                stroke-dasharray="${circumference}" stroke-dashoffset="${completedOffset}" 
                transform="rotate(-90 ${centerX} ${centerY})" />`;
      }
      
      // Pending slice (yellow) - continues from where completed ends
      if (pending > 0) {
        const pendingLength = pendingPercent * circumference;
        const pendingOffset = circumference - pendingLength;
        const startAngle = -90 + (completedPercent * 360);
        svg += `<circle cx="${centerX}" cy="${centerY}" r="${radius}" fill="none" stroke="#ffc107" stroke-width="40" 
                stroke-dasharray="${circumference}" stroke-dashoffset="${pendingOffset}" 
                transform="rotate(${startAngle} ${centerX} ${centerY})" />`;
      }
      
      // Center text
      svg += `<text x="${centerX}" y="${centerY - 10}" text-anchor="middle" font-size="28" font-weight="bold" fill="#333">${total}</text>`;
      svg += `<text x="${centerX}" y="${centerY + 15}" text-anchor="middle" font-size="14" fill="#666">Total Tasks</text>`;
      
      svg += `</svg>`;
      
      document.getElementById(containerId).innerHTML = svg;
    }
    
    // Initialize tracker dashboard
    function initTrackerDashboard(userRole) {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayStr = `${year}-${month}-${day}`;
      
      // Show/hide user management based on role
      const userManagementSection = document.getElementById('user-management-section');
      if (userManagementSection) {
        if (userRole === 'tracker') {
          userManagementSection.style.display = 'block';
          loadStaffUsers();
        } else {
          userManagementSection.style.display = 'none';
        }
      }
      
      const dateFilter = document.getElementById('tracker-date-filter');
      if (dateFilter) {
        dateFilter.value = todayStr;
        dateFilter.addEventListener('change', () => {
          updateTrackerDashboard();
        });
        updateTrackerDashboard();
      }
      
      // Initialize task checklist date filter
      const taskDateFilter = document.getElementById('tracker-task-date-filter');
      if (taskDateFilter) {
        taskDateFilter.value = todayStr;
        taskDateFilter.addEventListener('change', () => {
          loadTrackerTasks();
        });
        
        // Set up event delegation for checkboxes once
        const trackerTasksContainer = document.getElementById('tracker-tasks-container');
        // Remove old listener if it exists
        if (trackerCheckboxHandler) {
          trackerTasksContainer.removeEventListener('change', trackerCheckboxHandler);
        }
        // Create new handler
        trackerCheckboxHandler = function(e) {
          if (e.target.type === 'checkbox' && e.target.hasAttribute('data-task-id')) {
            const taskId = e.target.getAttribute('data-task-id');
            const completed = e.target.checked;
            toggleTaskCompletion(taskId, completed);
            // Refresh both dashboard and task list
            updateTrackerDashboard();
            loadTrackerTasks();
          }
        };
        trackerTasksContainer.addEventListener('change', trackerCheckboxHandler);
        
        loadTrackerTasks();
      }
    }
    
    // Load and display tasks for tracker view (with ability to manage)
    function loadTrackerTasks() {
      const dateStr = document.getElementById('tracker-task-date-filter').value;
      if (!dateStr) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('tracker-task-date-filter').value = `${year}-${month}-${day}`;
        loadTrackerTasks();
        return;
      }
      
      const container = document.getElementById('tracker-tasks-container');
      
      // Set up real-time listener for this date
      setupTasksListener(dateStr, (tasks) => {
        renderTasks(tasks, dateStr, container, 'handleTrackerCheckbox');
      });
    }
    
    // Toggle user management section
    function toggleUserManagement() {
      const content = document.getElementById('user-management-content');
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
      if (content.style.display === 'block') {
        loadStaffUsers();
      }
    }
    
    // Load and display staff users
    function loadStaffUsers() {
      const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
      const container = document.getElementById('staff-users-list');
      
      // Filter only staff users (exclude admin, tracker)
      const staffUsers = Object.entries(users).filter(([username, user]) => user.role === 'staff');
      
      if (staffUsers.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">No staff users found.</p>';
        return;
      }
      
      let html = '<h3 style="color: #0066cc; margin-bottom: 15px;">Current Staff Users</h3>';
      html += '<div style="display: grid; gap: 15px;">';
      
      staffUsers.forEach(([username, user]) => {
        html += `<div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">`;
        html += `<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">`;
        html += `<div>`;
        html += `<strong style="color: #333; font-size: 16px;">${username}</strong>`;
        html += `<div style="font-size: 12px; color: #666; margin-top: 3px;">Role: Staff</div>`;
        html += `</div>`;
        html += `<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">`;
        html += `<input type="password" id="password-${username}" placeholder="New password" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">`;
        html += `<button onclick="changeStaffPassword('${username}')" style="padding: 6px 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Change Password</button>`;
        html += `<button onclick="deleteStaffUser('${username}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Delete</button>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // Change staff user password
    function changeStaffPassword(username) {
      const newPassword = document.getElementById(`password-${username}`).value.trim();
      if (!newPassword) {
        alert('Please enter a new password.');
        return;
      }
      
      const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
      if (users[username] && users[username].role === 'staff') {
        users[username].password = newPassword;
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        document.getElementById(`password-${username}`).value = '';
        alert(`Password updated successfully for ${username}.`);
        loadStaffUsers();
      } else {
        alert('User not found or is not a staff user.');
      }
    }
    
    // Delete staff user
    function deleteStaffUser(username) {
      if (!confirm(`Are you sure you want to delete the staff user "${username}"?`)) {
        return;
      }
      
      const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
      if (users[username] && users[username].role === 'staff') {
        delete users[username];
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        alert(`Staff user "${username}" has been deleted.`);
        loadStaffUsers();
      } else {
        alert('User not found or is not a staff user.');
      }
    }
    
    // Add new staff user
    function addStaffUser() {
      const username = document.getElementById('new-staff-username').value.trim();
      const password = document.getElementById('new-staff-password').value.trim();
      
      if (!username || !password) {
        alert('Please enter both username and password.');
        return;
      }
      
      const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
      if (users[username]) {
        alert('Username already exists. Please choose a different username.');
        return;
      }
      
      users[username] = { password: password, role: 'staff' };
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
      
      document.getElementById('new-staff-username').value = '';
      document.getElementById('new-staff-password').value = '';
      
      alert(`Staff user "${username}" has been added successfully.`);
      loadStaffUsers();
    }
    
    // Update tracker dashboard
    function updateTrackerDashboard() {
      const dateStr = document.getElementById('tracker-date-filter').value;
      if (!dateStr) {
        // Default to today if no date selected
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('tracker-date-filter').value = `${year}-${month}-${day}`;
        updateTrackerDashboard();
        return;
      }
      
      const container = document.getElementById('tracker-dashboard-content');
      calculateTaskStats(dateStr, (stats) => {
        renderTrackerDashboard(stats, container, dateStr);
      });
    }
    
    function renderTrackerDashboard(stats, container, dateStr) {
      
      let html = `<div class="stats-container">`;
      
      // Statistics boxes
      html += `<div class="stats-box">`;
      html += `<h3>Total Tasks</h3>`;
      html += `<div class="number total">${stats.total}</div>`;
      html += `</div>`;
      
      html += `<div class="stats-box">`;
      html += `<h3>Completed</h3>`;
      html += `<div class="number completed">${stats.completed}</div>`;
      html += `<div style="font-size:12px;color:#666;">${stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0}%</div>`;
      html += `</div>`;
      
      html += `<div class="stats-box">`;
      html += `<h3>Pending</h3>`;
      html += `<div class="number pending">${stats.pending}</div>`;
      html += `<div style="font-size:12px;color:#666;">${stats.total > 0 ? ((stats.pending / stats.total) * 100).toFixed(1) : 0}%</div>`;
      html += `</div>`;
      
      html += `</div>`;
      
      // Pie chart
      html += `<div style="margin-top:30px;">`;
      html += `<div class="pie-chart-container" id="pie-chart"></div>`;
      html += `<div class="chart-legend">`;
      html += `<div class="legend-item"><span class="legend-color" style="background:#28a745;"></span><span>Completed (${stats.completed})</span></div>`;
      html += `<div class="legend-item"><span class="legend-color" style="background:#ffc107;"></span><span>Pending (${stats.pending})</span></div>`;
      html += `</div>`;
      html += `</div>`;
      
      container.innerHTML = html;
      
      // Create pie chart
      createPieChart(stats.completed, stats.pending, 'pie-chart');
    }
    
    // Update task completion status in Firebase or localStorage
    function toggleTaskCompletion(taskId, completed) {
      if (useFirebase && database) {
        database.ref('tasks/' + taskId + '/completed').set(completed)
          .catch(error => {
            console.error('Error updating task:', error);
            alert('Error updating task. Please try again.');
          });
      } else {
        // Fallback to localStorage
        const tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
        const task = tasks.find(t => t.id === taskId);
        if (task) {
          task.completed = completed;
          localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
        }
      }
    }
    
    // Handle checkbox change for staff view
    function handleTaskCheckbox(checkbox) {
      const taskId = checkbox.getAttribute('data-task-id');
      const completed = checkbox.checked;
      toggleTaskCompletion(taskId, completed);
      // Refresh the display
      const currentDateStr = document.getElementById('task-date-filter').value;
      displayTasks(currentDateStr);
    }
    
    // Handle checkbox change for tracker/clinical view
    function handleTrackerCheckbox(checkbox) {
      const taskId = checkbox.getAttribute('data-task-id');
      const completed = checkbox.checked;
      toggleTaskCompletion(taskId, completed);
      // Refresh both dashboard and task list
      updateTrackerDashboard();
      loadTrackerTasks();
    }
    
    // Initialize staff dashboard
    function initStaffDashboard() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayStr = `${year}-${month}-${day}`;
      
      const dateFilter = document.getElementById('task-date-filter');
      dateFilter.value = todayStr;
      dateFilter.addEventListener('change', () => {
        displayTasks(dateFilter.value);
      });
      
      // Set up event delegation for checkboxes once
      const tasksContainer = document.getElementById('tasks-container');
      // Remove old listener if it exists
      if (staffCheckboxHandler) {
        tasksContainer.removeEventListener('change', staffCheckboxHandler);
      }
      // Create new handler
      staffCheckboxHandler = function(e) {
        if (e.target.type === 'checkbox' && e.target.hasAttribute('data-task-id')) {
          const taskId = e.target.getAttribute('data-task-id');
          const completed = e.target.checked;
          toggleTaskCompletion(taskId, completed);
          // Refresh the display
          const currentDateStr = document.getElementById('task-date-filter').value;
          displayTasks(currentDateStr);
        }
      };
      tasksContainer.addEventListener('change', staffCheckboxHandler);
      
      displayTasks(todayStr);
    }
    
    // Render tasks to container (reusable function)
    function renderTasks(tasks, dateStr, container, checkboxHandler = 'handleTaskCheckbox') {
      if (tasks.length === 0) {
        container.innerHTML = '<div class="no-tasks">No tasks found for this date.</div>';
        return;
      }
      
      // Group tasks by patient
      const tasksByPatient = {};
      tasks.forEach(task => {
        if (!tasksByPatient[task.patientName]) {
          tasksByPatient[task.patientName] = [];
        }
        tasksByPatient[task.patientName].push(task);
      });
      
      let html = '';
      Object.entries(tasksByPatient).forEach(([patientName, patientTasks]) => {
        html += `<div class="task-card">`;
        html += `<div class="task-header">Patient: ${patientName} | Date of Service: ${formatDate(dateStr)}</div>`;
        
        patientTasks.forEach((task, index) => {
          html += `<div class="task-item ${task.completed ? 'completed' : ''}">`;
          html += `<input type="checkbox" id="task-${task.id}-${index}" data-task-id="${task.id}" ${task.completed ? 'checked' : ''} onchange="${checkboxHandler}(this)">`;
          html += `<div style="flex: 1;">`;
          html += `<div class="task-category">${task.category}</div>`;
          html += `<div class="task-details"><strong>${task.taskText}</strong>`;
          if (task.details && task.details.length > 0) {
            html += ` - ${task.details.join(', ')}`;
          }
          html += `</div>`;
          html += `</div>`;
          html += `</div>`;
        });
        
        html += `</div>`;
      });
      
      container.innerHTML = html;
    }
    
    // Display tasks for a date (staff view)
    function displayTasks(dateStr) {
      const container = document.getElementById('tasks-container');
      
      // Set up real-time listener for this date
      setupTasksListener(dateStr, (tasks) => {
        renderTasks(tasks, dateStr, container, 'handleTaskCheckbox');
      });
    }
    
    // Print/Save all tasks for the selected date
    function printAllTasks() {
      const dateStr = document.getElementById('task-date-filter').value;
      getTasksForDateAsync(dateStr, (tasks) => {
        if (tasks.length === 0) {
          alert('No tasks found for this date.');
          return;
        }
        printTasksHTML(tasks, dateStr);
      });
    }
    
    function printTasksHTML(tasks, dateStr) {
      
      // Group tasks by patient
      const tasksByPatient = {};
      tasks.forEach(task => {
        if (!tasksByPatient[task.patientName]) {
          tasksByPatient[task.patientName] = [];
        }
        tasksByPatient[task.patientName].push(task);
      });
      
      // Generate print-ready HTML
      const pw = window.open('', '_blank');
      let html = `<!DOCTYPE html><html><head><title>Staff To-Do List - ${formatDate(dateStr)}</title><style>
        body{font-family:Arial,sans-serif;color:#333;margin:20px;font-size:12px;}
        h1{text-align:center;color:#0066cc;margin-bottom:20px;border-bottom:3px solid #0066cc;padding-bottom:10px;font-size:20px;}
        h2{color:#0066cc;margin:20px 0 10px;font-size:16px;border-bottom:2px solid #0066cc;padding-bottom:5px;}
        .task-card{background:#f5f5f5;border:2px solid #0066cc;border-radius:6px;padding:15px;margin-bottom:20px;page-break-inside:avoid;}
        .task-header{background:#0066cc;color:#fff;padding:10px;border-radius:4px 4px 0 0;margin:-15px -15px 15px -15px;font-weight:bold;font-size:13px;}
        .task-item{padding:8px;margin:5px 0;background:white;border-left:4px solid #0066cc;border-radius:4px;page-break-inside:avoid;}
        .task-category{font-weight:bold;color:#0066cc;margin-bottom:3px;font-size:12px;}
        .task-details{font-size:11px;color:#666;margin-left:20px;}
        .task-item.completed{opacity:0.6;text-decoration:line-through;}
        .summary{background:#e8f4f8;padding:15px;border-radius:6px;margin-bottom:20px;border-left:5px solid #0066cc;}
        .summary-item{margin:5px 0;font-size:12px;}
        @media print{
          .task-card{page-break-inside:avoid;}
          .task-item{page-break-inside:avoid;}
          body{margin:10px;}
        }
      </style></head><body>`;
      
      html += `<h1>Staff To-Do List - ${formatDate(dateStr)}</h1>`;
      
      // Add summary
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(t => t.completed).length;
      const pendingTasks = totalTasks - completedTasks;
      
      html += `<div class="summary">`;
      html += `<div class="summary-item"><strong>Total Tasks:</strong> ${totalTasks}</div>`;
      html += `<div class="summary-item"><strong>Completed:</strong> ${completedTasks}</div>`;
      html += `<div class="summary-item"><strong>Pending:</strong> ${pendingTasks}</div>`;
      html += `<div class="summary-item"><strong>Date:</strong> ${formatDate(dateStr)}</div>`;
      html += `<div class="summary-item"><strong>Generated:</strong> ${new Date().toLocaleString()}</div>`;
      html += `</div>`;
      
      // Add tasks grouped by patient
      Object.entries(tasksByPatient).forEach(([patientName, patientTasks]) => {
        html += `<div class="task-card">`;
        html += `<div class="task-header">Patient: ${patientName} | Date of Service: ${formatDate(dateStr)}</div>`;
        
        patientTasks.forEach(task => {
          html += `<div class="task-item ${task.completed ? 'completed' : ''}">`;
          html += `<div class="task-category">${task.category}</div>`;
          html += `<div class="task-details"><strong>${task.taskText}</strong>`;
          if (task.details && task.details.length > 0) {
            html += ` - ${task.details.join(', ')}`;
          }
          html += ` ${task.completed ? 'âœ“ COMPLETED' : 'â˜ PENDING'}`;
          html += `</div>`;
          html += `</div>`;
        });
        
        html += `</div>`;
      });
      
      html += `<div style="margin-top:30px;padding:15px;background:#fff3cd;border:1px solid #ffc107;border-radius:4px;font-size:12px;text-align:center;">`;
      html += `<strong>West Houston Heart Center</strong><br>`;
      html += `Dr. Humayun Naqvi, MD, MBA, FACC<br>`;
      html += `Phone: 832-271-5897 | Fax: 1 (877) 669-0063<br>`;
      html += `<a href="https://www.htxheart.com" style="color:#c00;">www.htxheart.com</a>`;
      html += `</div>`;
      
      html += `</body></html>`;
      pw.document.write(html);
      pw.document.close();
      
      // Wait a moment for content to load, then trigger print
      setTimeout(() => {
        pw.focus();
        pw.print();
      }, 250);
    }
    
    // Download all tasks as HTML file
    function downloadAllTasks() {
      const dateStr = document.getElementById('task-date-filter').value;
      getTasksForDateAsync(dateStr, (tasks) => {
        if (tasks.length === 0) {
          alert('No tasks found for this date.');
          return;
        }
        downloadTasksHTML(tasks, dateStr);
      });
    }
    
    function downloadTasksHTML(tasks, dateStr) {
      
      // Group tasks by patient
      const tasksByPatient = {};
      tasks.forEach(task => {
        if (!tasksByPatient[task.patientName]) {
          tasksByPatient[task.patientName] = [];
        }
        tasksByPatient[task.patientName].push(task);
      });
      
      // Generate HTML content
      let html = `<!DOCTYPE html><html><head><title>Staff To-Do List - ${formatDate(dateStr)}</title><style>
        body{font-family:Arial,sans-serif;color:#333;margin:20px;font-size:12px;}
        h1{text-align:center;color:#0066cc;margin-bottom:20px;border-bottom:3px solid #0066cc;padding-bottom:10px;font-size:20px;}
        h2{color:#0066cc;margin:20px 0 10px;font-size:16px;border-bottom:2px solid #0066cc;padding-bottom:5px;}
        .task-card{background:#f5f5f5;border:2px solid #0066cc;border-radius:6px;padding:15px;margin-bottom:20px;page-break-inside:avoid;}
        .task-header{background:#0066cc;color:#fff;padding:10px;border-radius:4px 4px 0 0;margin:-15px -15px 15px -15px;font-weight:bold;font-size:13px;}
        .task-item{padding:8px;margin:5px 0;background:white;border-left:4px solid #0066cc;border-radius:4px;page-break-inside:avoid;}
        .task-category{font-weight:bold;color:#0066cc;margin-bottom:3px;font-size:12px;}
        .task-details{font-size:11px;color:#666;margin-left:20px;}
        .task-item.completed{opacity:0.6;text-decoration:line-through;}
        .summary{background:#e8f4f8;padding:15px;border-radius:6px;margin-bottom:20px;border-left:5px solid #0066cc;}
        .summary-item{margin:5px 0;font-size:12px;}
        @media print{
          .task-card{page-break-inside:avoid;}
          .task-item{page-break-inside:avoid;}
          body{margin:10px;}
        }
      </style></head><body>`;
      
      html += `<h1>Staff To-Do List - ${formatDate(dateStr)}</h1>`;
      
      // Add summary
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(t => t.completed).length;
      const pendingTasks = totalTasks - completedTasks;
      
      html += `<div class="summary">`;
      html += `<div class="summary-item"><strong>Total Tasks:</strong> ${totalTasks}</div>`;
      html += `<div class="summary-item"><strong>Completed:</strong> ${completedTasks}</div>`;
      html += `<div class="summary-item"><strong>Pending:</strong> ${pendingTasks}</div>`;
      html += `<div class="summary-item"><strong>Date:</strong> ${formatDate(dateStr)}</div>`;
      html += `<div class="summary-item"><strong>Generated:</strong> ${new Date().toLocaleString()}</div>`;
      html += `</div>`;
      
      // Add tasks grouped by patient
      Object.entries(tasksByPatient).forEach(([patientName, patientTasks]) => {
        html += `<div class="task-card">`;
        html += `<div class="task-header">Patient: ${patientName} | Date of Service: ${formatDate(dateStr)}</div>`;
        
        patientTasks.forEach(task => {
          html += `<div class="task-item ${task.completed ? 'completed' : ''}">`;
          html += `<div class="task-category">${task.category}</div>`;
          html += `<div class="task-details"><strong>${task.taskText}</strong>`;
          if (task.details && task.details.length > 0) {
            html += ` - ${task.details.join(', ')}`;
          }
          html += ` ${task.completed ? 'âœ“ COMPLETED' : 'â˜ PENDING'}`;
          html += `</div>`;
          html += `</div>`;
        });
        
        html += `</div>`;
      });
      
      html += `<div style="margin-top:30px;padding:15px;background:#fff3cd;border:1px solid #ffc107;border-radius:4px;font-size:12px;text-align:center;">`;
      html += `<strong>West Houston Heart Center</strong><br>`;
      html += `Dr. Humayun Naqvi, MD, MBA, FACC<br>`;
      html += `Phone: 832-271-5897 | Fax: 1 (877) 669-0063<br>`;
      html += `<a href="https://www.htxheart.com" style="color:#c00;">www.htxheart.com</a>`;
      html += `</div>`;
      
      html += `</body></html>`;
      
      // Create download link
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Staff_Tasks_${dateStr.replace(/-/g, '_')}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Format date helper
    function formatDate(val) {
      if (!val) return '';
      const parts = val.split('-');
      const y = parts[0], m = parts[1].replace(/^0/, ''), d = parts[2].replace(/^0/, '');
      return `${m}/${d}/${y}`;
    }
    
    // Patient-friendly test descriptions (same as before)
    const TEST_DESCRIPTIONS = {
      'Exercise treadmill stress test': 'This test evaluates how your heart performs during physical activity. You will walk on a treadmill while we monitor your heart rate, blood pressure, and heart rhythm. This helps us assess your heart\'s response to exercise and identify any potential issues.',
      'Lexiscan Nuclear stress test': 'This test uses a small amount of radioactive tracer to create images of your heart at rest and during stress. You will receive medication to simulate exercise, and we will take pictures of your heart to check blood flow and identify any areas that may not be receiving adequate blood supply.',
      'Exercise Nuclear stress test': 'Similar to the Lexiscan test, but you will exercise on a treadmill instead of receiving medication. This test uses a radioactive tracer to show how well blood flows to your heart muscle during physical activity.',
      'Stress Echocardiogram': 'This test combines an ultrasound of your heart with exercise or medication to see how well your heart pumps blood during stress. It helps identify areas of the heart that may not be functioning properly under stress.',
      'PET Stress': 'This advanced imaging test uses a radioactive tracer to create detailed 3D images of your heart. It provides very accurate information about blood flow to your heart muscle and can detect even small areas of reduced blood supply.',
      'Mobile Cardiac Telemetry': 'A Mobile Cardiac Telemetry (MCT) device is a small, wearable monitor that continuously records your heart rhythm. You will wear it for the specified number of days, and it automatically sends your heart rhythm data to our monitoring center for review.',
      'Extended Holter Monitor': 'A Holter monitor is a portable device that continuously records your heart rhythm for an extended period. You will wear electrodes on your chest connected to a small recorder that you carry with you. This helps us identify irregular heart rhythms that may not occur during a brief office visit.',
      'Ambulatory Blood Pressure Monitor': 'This device automatically measures your blood pressure at regular intervals throughout the day and night while you go about your normal activities. It provides a more complete picture of your blood pressure patterns than single office measurements.',
      'Clinii Blood Pressure Cuff': 'A home blood pressure monitoring device that connects to our clinic. You will take regular blood pressure readings at home, and the device automatically sends the data to our office so we can track your blood pressure over time.',
      'Clinii Weight Scale': 'A smart scale that automatically sends your weight measurements to our clinic. This helps us monitor fluid retention and overall health status, which is especially important for heart conditions.',
      'BioBridge Device Monitoring enrollment': 'This program allows us to remotely monitor your implanted cardiac device (pacemaker, defibrillator, or loop recorder). Your device will automatically send information to our office, so we can check on it regularly without you needing to come in.',
      'In Office Pacemaker Interrogation': 'During this visit, we will check your pacemaker\'s settings and battery life using a special device. We will also review any stored information about your heart rhythm to ensure your pacemaker is working correctly.',
      'Echocardiogram': 'An ultrasound of your heart that uses sound waves to create moving pictures of your heart\'s structure and function. It shows how well your heart pumps blood, the condition of your heart valves, and the size of your heart chambers. This is a painless test that takes about 30-45 minutes.',
      'Carotid Ultrasound': 'This ultrasound test examines the blood vessels in your neck (carotid arteries) that supply blood to your brain. It helps identify any narrowing or blockages that could increase your risk of stroke.',
      'Ankle-Brachial Index': 'This simple test compares the blood pressure in your ankles to the blood pressure in your arms. It helps detect peripheral artery disease, which is narrowing of arteries in your legs that can cause pain when walking.',
      'Peripheral Arterial Doppler': 'This ultrasound test examines the blood flow in the arteries of your arms or legs. It helps identify blockages or narrowing that may be causing symptoms like pain, numbness, or poor circulation.',
      'Abdominal Aortic Aneurysm Screen': 'An ultrasound of your abdomen to check for an enlarged area (aneurysm) in the main blood vessel (aorta) that carries blood from your heart. Early detection is important to prevent serious complications.',
      'Venous Study': 'An ultrasound test that examines the veins in your legs or arms to check for blood clots (deep vein thrombosis) or problems with vein function. It helps diagnose conditions like varicose veins or blood clots.',
      'Cardiac CTA': 'A specialized CT scan that creates detailed 3D images of your heart and coronary arteries. It uses contrast dye injected through an IV to visualize the blood vessels and can detect blockages or narrowing. This is a non-invasive alternative to cardiac catheterization.',
      'Cardiac CTA w/ FFR': 'This advanced cardiac CT scan includes Fractional Flow Reserve analysis, which uses computer modeling to determine if any blockages in your arteries are significant enough to affect blood flow to your heart muscle.',
      'Cardiac CTA with Cleerly Plaque analysis': 'This specialized cardiac CT scan uses advanced software (Cleerly) to analyze plaque in your coronary arteries. It provides detailed information about the type and amount of plaque, helping assess your risk of heart disease and guide treatment decisions.',
      'Calcium Score': 'A quick CT scan that measures the amount of calcium in your coronary arteries. Calcium buildup indicates plaque in your arteries. This test helps assess your risk of heart disease even before symptoms develop.',
      'CTA Carotid': 'A CT scan with contrast dye that creates detailed images of the carotid arteries in your neck. It provides more detailed information than ultrasound and helps evaluate your risk of stroke.',
      'CT Thoracic aorta': 'A CT scan that examines the portion of the aorta (main artery) in your chest. It helps detect aneurysms, dissections, or other abnormalities in this important blood vessel.',
      'Cardiac MRI': 'A magnetic resonance imaging test that uses powerful magnets and radio waves to create detailed images of your heart. It provides excellent images of heart structure, function, and can assess heart muscle damage or inflammation. No radiation is used.',
      'PYP Scan': 'A nuclear medicine test that uses a radioactive tracer to detect a specific type of heart condition called cardiac amyloidosis, where abnormal proteins build up in the heart muscle.',
      'FDG PET': 'A specialized PET scan that uses a radioactive sugar tracer to identify areas of inflammation or infection in the heart. It helps diagnose conditions like cardiac sarcoidosis or infections of the heart.',
      'Sleep Study': 'An overnight test that monitors your breathing, heart rate, oxygen levels, and brain activity while you sleep. It helps diagnose sleep apnea, which can contribute to heart problems and high blood pressure.',
      'Other': 'Additional imaging test as specified by your doctor.',
      'Left Heart Catheterization': 'A procedure where a thin tube (catheter) is inserted through an artery (usually in your wrist or groin) and guided to your heart. Contrast dye is injected to visualize your coronary arteries and check for blockages. This is the gold standard test for diagnosing coronary artery disease.',
      'Right Heart Catheterization': 'A procedure where a catheter is inserted through a vein and guided to the right side of your heart and lungs. It measures pressures in your heart and lungs, helping diagnose and manage conditions like heart failure or pulmonary hypertension.',
      'TEE': 'Transesophageal Echocardiogram - An ultrasound probe is passed through your mouth into your esophagus (food pipe) to get very clear images of your heart from behind. You will receive sedation for comfort. This provides better images than a regular echocardiogram.',
      'TEE w/ Cardioversion': 'A transesophageal echocardiogram followed by cardioversion, which uses an electrical shock to restore normal heart rhythm. The TEE ensures there are no blood clots in your heart before the procedure.',
      'Cardioversion only': 'A procedure that uses an electrical shock to restore your heart to a normal rhythm. You will receive sedation so you won\'t feel the shock. This is used to treat certain irregular heart rhythms.',
      'Loop Recorder Placement': 'A small device is implanted just under the skin of your chest to continuously monitor your heart rhythm for up to 3 years. It helps identify irregular rhythms that occur infrequently. The procedure is quick and done with local anesthesia.',
      'Dobutamine Stress Echo': 'An echocardiogram performed while you receive medication (dobutamine) that makes your heart work harder, simulating exercise. This is used when you cannot exercise on a treadmill. It helps assess how well your heart functions under stress.',
      'Tilt Table Test': 'You will lie on a table that tilts to different angles while we monitor your heart rate and blood pressure. This test helps diagnose fainting spells or dizziness that may be related to your heart or nervous system.',
      'Obtain Medical Records': 'We will request your medical records from other healthcare providers to ensure we have complete information about your medical history.',
      'Blood Pressure Log': 'You will keep a log of your blood pressure readings at home to help us monitor and manage your blood pressure more effectively.',
      'Labs are printed': 'Laboratory test orders have been printed for you to take to the lab.',
      'Please order labs': 'Laboratory tests have been ordered as specified.',
      'Send Preoperative Cardiac Risk Stratification Paperwork': 'We will send paperwork to help assess your cardiac risk before surgery. This helps ensure your safety during the procedure.',
      'Refer for Clinical Trial': 'You will be referred to a clinical trial as specified.',
      'Order Genetic Testing': 'Genetic testing will be ordered to help identify inherited heart conditions or genetic factors that may affect your cardiovascular health. This testing can help guide treatment decisions and provide important information for you and your family members.'
    };
    
    const TEST_CATEGORIES = {
      'Stress Tests': ['Exercise treadmill stress test','Lexiscan Nuclear stress test','Exercise Nuclear stress test','Stress Echocardiogram','PET Stress'],
      'Monitoring Device': ['Mobile Cardiac Telemetry','Extended Holter Monitor','Ambulatory Blood Pressure Monitor','Clinii Blood Pressure Cuff','Clinii Weight Scale','BioBridge Device Monitoring enrollment','In Office Pacemaker Interrogation'],
      'Office Imaging': ['Echocardiogram','Carotid Ultrasound','Ankle-Brachial Index','Peripheral Arterial Doppler','Abdominal Aortic Aneurysm Screen','Venous Study'],
      'Out-of-Office Imaging': ['Cardiac CTA','Cardiac CTA w/ FFR','Cardiac CTA with Cleerly Plaque analysis','Calcium Score','CTA Carotid','CT Thoracic aorta','Cardiac MRI','PYP Scan','FDG PET','Sleep Study','Other'],
      'Procedures': ['Left Heart Catheterization','Right Heart Catheterization','TEE','TEE w/ Cardioversion','Cardioversion only','Loop Recorder Placement','Dobutamine Stress Echo','Tilt Table Test'],
      'Obtain Medical Records': ['Obtain Medical Records'],
      'Blood Pressure Log': ['Blood Pressure Log'],
      'Labs are printed': ['Labs are printed'],
      'Please order labs': ['Please order labs'],
      'Preoperative Paperwork': ['Send Preoperative Cardiac Risk Stratification Paperwork'],
      'Refer for Clinical Trial': ['Refer for Clinical Trial'],
      'Order Genetic Testing': ['Order Genetic Testing']
    };
    const HOSPITAL_OPTIONS = ['Houston Methodist','Memorial Hermann','Methodist ASC'];
    const IMAGING_CENTERS = ['Simon Med','Houston Methodist','Memorial Hermann','Houston Medical Imaging','Live Healthy Imaging'];
    const BP_HOURS = ['24 hour','48 hour'];

    function createWrapper(category, test) {
      const div = document.createElement('div');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox'; checkbox.name = 'tests'; checkbox.value = test; checkbox.dataset.category = category;
      const label = document.createElement('label'); label.append(checkbox, ` ${test}`);
      div.appendChild(label);

      if (category === 'Monitoring Device' && /(Mobile Cardiac Telemetry|Extended Holter Monitor)/.test(test)) {
        const inp = document.createElement('input'); inp.type = 'number'; inp.min = '1'; inp.placeholder = 'Days'; inp.dataset.test = test;
        div.appendChild(inp);
      }
      if (category === 'Monitoring Device' && test === 'Ambulatory Blood Pressure Monitor') {
        const sel = document.createElement('select'); sel.dataset.test = test;
        BP_HOURS.forEach(h => { const o = document.createElement('option'); o.value = h; o.textContent = h; sel.appendChild(o); });
        div.appendChild(sel);
      }
      if (category === 'Out-of-Office Imaging') {
        if (test === 'Other') {
          const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'Specify imaging'; inp.dataset.test = test; div.appendChild(inp);
        }
        const sel = document.createElement('select'); sel.dataset.test = test;
        IMAGING_CENTERS.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
        div.appendChild(sel);
      }
      if (category === 'Procedures') {
        const sel = document.createElement('select'); sel.dataset.test = test;
        HOSPITAL_OPTIONS.forEach(h => { const o = document.createElement('option'); o.value = h; o.textContent = h; sel.appendChild(o); });
        div.appendChild(sel);
      }
      if (category === 'Please order labs') {
        const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'Specify labs...'; inp.dataset.test = test; div.appendChild(inp);
      }
      if (category === 'Refer for Clinical Trial') {
        const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'Trial name'; inp.dataset.test = test; div.appendChild(inp);
      }
      return div;
    }

    function initAdminForm() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayStr = `${year}-${month}-${day}`;
      
      document.getElementById('dos').value = todayStr;
      
      
      const categoriesDiv = document.getElementById('categories');
      categoriesDiv.innerHTML = '';
      const standalone = ['Obtain Medical Records','Blood Pressure Log','Labs are printed','Please order labs','Preoperative Paperwork','Refer for Clinical Trial','Order Genetic Testing'];
      Object.entries(TEST_CATEGORIES).forEach(([category, tests]) => {
        if (standalone.includes(category)) {
          tests.forEach(test => categoriesDiv.appendChild(createWrapper(category, test)));
        } else {
          const fs = document.createElement('fieldset');
          const lg = document.createElement('legend'); lg.textContent = category;
          fs.appendChild(lg);
          tests.forEach(test => fs.appendChild(createWrapper(category, test)));
          categoriesDiv.appendChild(fs);
        }
      });
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-message');
      if (message) {
        statusDiv.textContent = message;
        statusDiv.className = 'status-message status-' + type;
        statusDiv.style.display = 'block';
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      } else {
        statusDiv.style.display = 'none';
      }
    }

    // Form submission handler - saves tasks and generates print output
    document.getElementById('order-form').addEventListener('submit', e => {
      e.preventDefault();
      const patient = document.getElementById('patient-name').value.trim();
      const dosValue = document.getElementById('dos').value;
      const dos = formatDate(dosValue);
      const follow = document.getElementById('followup').value.trim();
      const refer = document.getElementById('referto').value.trim();
      const pcp = document.getElementById('pcp').checked;
      const mediterraneanDiet = document.getElementById('mediterranean-diet').checked;
      const exerciseRegimen = document.getElementById('exercise-regimen').checked;
      const instruct = document.getElementById('instructions').value.trim();
      const selected = document.querySelectorAll('input[name="tests"]:checked');
      
      // Save tasks to localStorage (only if tests are selected)
      const tasksByCategory = {};
      selected.forEach(box => {
        const category = box.dataset.category;
        if (!tasksByCategory[category]) tasksByCategory[category] = [];
        tasksByCategory[category].push(box);
      });
      
      Object.entries(tasksByCategory).forEach(([category, boxes]) => {
        boxes.forEach(box => {
          let taskText = box.value;
          let details = [];
          
          if (category === 'Monitoring Device' && /(Mobile Cardiac Telemetry|Extended Holter Monitor)/.test(box.value)) {
            const inp = document.querySelector(`input[data-test="${box.value}"]`);
            if (inp && inp.value) details.push(`${inp.value} days`);
          }
          
          if (category === 'Monitoring Device' && box.value === 'Ambulatory Blood Pressure Monitor') {
            const selBP = document.querySelector(`select[data-test="${box.value}"]`);
            if (selBP && selBP.value) details.push(selBP.value);
          }
          
          if (category === 'Procedures') {
            const sel = document.querySelector(`select[data-test="${box.value}"]`);
            if (sel && sel.value) details.push(`Location: ${sel.value}`);
          }
          
          if (category === 'Out-of-Office Imaging') {
            const sel = document.querySelector(`select[data-test="${box.value}"]`);
            if (sel && sel.value) details.push(`Imaging Center: ${sel.value}`);
            if (box.value === 'Other') {
              const inp = document.querySelector(`input[data-test="${box.value}"]`);
              if (inp && inp.value) details.push(`Imaging: ${inp.value}`);
            }
          }
          
          if (box.value === 'Please order labs') {
            const inp = document.querySelector(`input[data-test="${box.value}"]`);
            if (inp && inp.value) details.push(`Labs: ${inp.value}`);
          }
          
          if (box.value === 'Refer for Clinical Trial') {
            const inp = document.querySelector(`input[data-test="${box.value}"]`);
            if (inp && inp.value) details.push(`Trial: ${inp.value}`);
          }
          
          saveTask({
            patientName: patient,
            dateOfService: dosValue,
            category: category,
            taskText: taskText,
            details: details
          });
        });
      });
      
      if (follow) {
        saveTask({
          patientName: patient,
          dateOfService: dosValue,
          category: 'Follow-up',
          taskText: `Schedule follow-up visit: ${follow}`,
          details: []
        });
      }
      
      if (refer) {
        saveTask({
          patientName: patient,
          dateOfService: dosValue,
          category: 'Referral',
          taskText: `Process referral to: ${refer}`,
          details: []
        });
      }
      
      if (pcp) {
        saveTask({
          patientName: patient,
          dateOfService: dosValue,
          category: 'PCP Information',
          taskText: 'Update PCP information',
          details: []
        });
      }
      
      if (mediterraneanDiet) {
        saveTask({
          patientName: patient,
          dateOfService: dosValue,
          category: 'Patient Education',
          taskText: 'Give Mediterranean Diet Info handout to patient',
          details: []
        });
      }
      
      if (exerciseRegimen) {
        saveTask({
          patientName: patient,
          dateOfService: dosValue,
          category: 'Patient Education',
          taskText: 'Give Exercise Regimen Info handout to patient',
          details: []
        });
      }
      
      showStatus('Tasks saved successfully! Generating print page...', 'success');
      
      // Generate full print output with all tests, descriptions, and handouts
      const pw = window.open('', '_blank');
      let html = `<!DOCTYPE html><html><head><title>After Visit Summary</title><style>
        body{font-family:Arial,sans-serif;color:#333;margin:10px;}h1{text-align:center;color:#c00;margin-bottom:16px;}h2{text-align:center;color:#0066cc;margin:12px 0 8px;border-top:2px solid #0066cc;padding-top:8px;font-size:14px;}p{margin:12px 0;font-size:14px;}ul{list-style:none;padding:0;margin:8px 0;}li{padding:4px 0;border-bottom:1px solid #eee;font-size:14px;} .section-title{font-weight:bold;margin:12px 0 4px;} .signature{margin-top:16px;border-top:1px solid #ccc;padding-top:8px;font-size:12px;color:#555;text-align:center;}.signature a{color:#c00;text-decoration:none;} .todo-list{background:#f5f5f5;border:2px solid #0066cc;border-radius:6px;padding:8px;margin:12px 0;} .todo-item{padding:5px;margin:4px 0;background:#fff;border-left:4px solid #0066cc;border-radius:4px;display:flex;align-items:flex-start;} .todo-item input[type="checkbox"]{margin-right:8px;margin-top:2px;width:16px;height:16px;cursor:pointer;} .todo-item label{flex:1;cursor:pointer;} .todo-category{font-weight:bold;color:#0066cc;margin-bottom:2px;font-size:11px;} .todo-details{font-size:10px;color:#666;margin-left:24px;} .staff-header{background:#0066cc;color:#fff;padding:6px;border-radius:4px 4px 0 0;margin:-8px -8px 8px -8px;font-weight:bold;font-size:11px;} .logo-container{text-align:center;margin:20px 0;}
        .no-break{page-break-inside:avoid;} .handout-page{page-break-before:always;page-break-after:always;page-break-inside:avoid;}
        table{page-break-inside:avoid;} thead{display:table-header-group;} tbody{display:table-row-group;} tr{page-break-inside:avoid;page-break-after:auto;}
        h2,h3{page-break-after:avoid;page-break-inside:avoid;} .content-section{page-break-inside:avoid;} div[style*="background"]{page-break-inside:avoid;}
        ul,ol{page-break-inside:avoid;} li{page-break-inside:avoid;}
        @media print{
          .handout-page{page-break-before:always;page-break-after:always;page-break-inside:avoid !important;}
          table{page-break-inside:avoid !important;} tr{page-break-inside:avoid !important;page-break-after:auto;}
          h2,h3{page-break-after:avoid !important;orphans:3;widows:3;}
          .content-section,div[style*="background"]{page-break-inside:avoid !important;}
        }
      </style></head><body class="output">`;
      
      // Generate After Visit Summary (1 copy for patient) - keep together
      html += `<div class="no-break">`;
      html += `<h1>After Visit Summary</h1>`;
      html += `<p>Thank you for visiting West Houston Heart Center and trusting us with your care.</p>`;
      if (selected.length > 0) {
        html += `<p style="margin-top:12px;">We have summarized all the tests ordered during your visit along with detailed descriptions to help you understand what each test involves. If you have any questions about your tests, results, or treatment plan, please don't hesitate to message us through the <strong>Healow portal</strong> or call our office directly at <strong>832-271-5897</strong>. We're here to help!</p>`;
      } else {
        html += `<p style="margin-top:12px;">If you have any questions about your visit, results, or treatment plan, please don't hesitate to message us through the <strong>Healow portal</strong> or call our office directly at <strong>832-271-5897</strong>. We're here to help!</p>`;
      }
      html += `<p><strong>Patient:</strong> ${patient}</p><p><strong>Date of Service:</strong> ${dos}</p>`;
      html += `<p class="section-title">Ordered Tests:</p>`;
      
      // Group tests by category
      const testsByCategory = {};
      selected.forEach(box => {
        const category = box.dataset.category;
        if (!testsByCategory[category]) testsByCategory[category] = [];
        testsByCategory[category].push(box);
      });
      
      // Display tests grouped by category
      if (Object.keys(testsByCategory).length === 0) {
        html += `<p><em>No tests were ordered during this visit.</em></p>`;
      } else {
        Object.entries(testsByCategory).forEach(([category, boxes]) => {
        html += `<h3 style="color:#c00;margin-top:15px;margin-bottom:8px;font-size:15px;font-weight:bold;">${category}:</h3>`;
        html += `<ul>`;
        boxes.forEach(box => {
          let text;
          // Handle items where category and value are the same (standalone items with input)
          if (box.value === 'Refer for Clinical Trial') {
            const inp = document.querySelector(`input[data-test="${box.value}"]`);
            text = `Refer for Clinical Trial${inp && inp.value ? ': ' + inp.value : ''}`;
          } else if (box.value === 'Please order labs') {
            const inp = document.querySelector(`input[data-test="${box.value}"]`);
            text = `Please order labs${inp && inp.value ? ': ' + inp.value : ''}`;
          } else {
            text = box.value;
            // Include days for Mobile Cardiac Telemetry/Extended Holter Monitor
            if (box.dataset.category === 'Monitoring Device' && /(Mobile Cardiac Telemetry|Extended Holter Monitor)/.test(box.value)) {
              const inp = document.querySelector(`input[data-test="${box.value}"]`);
              if (inp && inp.value) text += ` (${inp.value} days)`;
            }
            // Include duration for Ambulatory BP monitor
            if (box.dataset.category === 'Monitoring Device' && box.value === 'Ambulatory Blood Pressure Monitor') {
              const selBP = document.querySelector(`select[data-test="${box.value}"]`);
              if (selBP && selBP.value) text += ` (${selBP.value})`;
            }
            if (box.dataset.category === 'Procedures') {
              const sel = document.querySelector(`select[data-test="${box.value}"]`);
              if (sel) text += ` at ${sel.value}`;
            }
            if (box.dataset.category === 'Out-of-Office Imaging') {
              if (box.value === 'Other') {
                const inp = document.querySelector(`input[data-test="${box.value}"]`);
                if (inp && inp.value) text += `: ${inp.value}`;
              }
              const sel = document.querySelector(`select[data-test="${box.value}"]`);
              if (sel) text += ` from ${sel.value}`;
            }
          }
          html += `<li>${text}</li>`;
        });
        html += `</ul>`;
      });
      }
      
      if (follow) {
        html += `<p><strong>Follow up in:</strong> ${follow}</p>`;
        html += `<p style="margin-top:8px;"><strong>Appointment Date:</strong> ___________________________ <span style="font-size:12px;color:#666;">(Staff: Please write the exact date)</span></p>`;
      }
      if (refer) html += `<p><strong>Refer to:</strong> ${refer}</p>`;
      if (instruct) html += `<p><strong>Instructions:</strong> ${instruct}</p>`;
      html += `<div class="signature"><p>Dr. Humayun Naqvi, MD, MBA, FACC<br>West Houston Heart Center<br>Phone: 832-271-5897 | Fax: 1 (877) 669-0063<br><a href="https://www.htxheart.com">www.htxheart.com</a></p></div>`;
      
      // Add No Show Policy
      html += `<div style="margin-top:20px;padding:15px;background:#fff3cd;border:2px solid #ffc107;border-radius:6px;page-break-inside:avoid;">`;
      html += `<h3 style="color:#856404;margin-top:0;margin-bottom:10px;font-size:16px;">âš ï¸ No Show Policy</h3>`;
      html += `<p style="font-size:13px;line-height:1.6;margin-bottom:0;color:#333;">Please be aware that <strong>not cancelling your appointment at least 24 hours (one business day) in advance</strong> will result in a <strong>no show fee</strong>. We appreciate your understanding as this helps us serve all our patients better by allowing us to offer your appointment time to others who need care.</p>`;
      html += `<p style="font-size:13px;line-height:1.6;margin-top:10px;margin-bottom:0;color:#333;">To cancel or reschedule, please call us at <strong>832-271-5897</strong> at least 24 hours before your scheduled appointment.</p>`;
      html += `</div>`;
      html += `</div>`;
      
      // Add patient-friendly test descriptions after the After Visit Summary (only if tests were ordered)
      if (selected.length > 0) {
        html += `<div style="margin-top:20px;padding:15px;background:#f9f9f9;border-left:4px solid #c00;border-radius:4px;">`;
        html += `<h2 style="color:#c00;margin-top:0;margin-bottom:12px;font-size:16px;">Understanding Your Tests</h2>`;
        html += `<p style="margin-bottom:12px;font-size:13px;line-height:1.6;">The following section explains each test that has been ordered for you in simple terms:</p>`;
        
        selected.forEach(box => {
        let testName = box.value;
        let description = TEST_DESCRIPTIONS[testName];
        
        // Handle "Other" option with custom text
        if (testName === 'Other' && box.dataset.category === 'Out-of-Office Imaging') {
          const inp = document.querySelector(`input[data-test="${testName}"]`);
          if (inp && inp.value) {
            testName = `Other: ${inp.value}`;
            description = TEST_DESCRIPTIONS['Other'];
          }
        }
        
        // Handle "Please order labs" with custom text
        if (testName === 'Please order labs') {
          const inp = document.querySelector(`input[data-test="${testName}"]`);
          if (inp && inp.value) {
            testName = `Please order labs: ${inp.value}`;
          }
        }
        
        // Handle "Refer for Clinical Trial" with custom text
        if (testName === 'Refer for Clinical Trial') {
          const inp = document.querySelector(`input[data-test="${testName}"]`);
          if (inp && inp.value) {
            testName = `Refer for Clinical Trial: ${inp.value}`;
          }
        }
        
        if (description) {
          html += `<div style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #ddd;">`;
          html += `<strong style="color:#c00;font-size:14px;">${testName}</strong>`;
          html += `<p style="margin-top:6px;margin-bottom:0;font-size:13px;line-height:1.6;color:#555;">${description}</p>`;
          html += `</div>`;
        }
      });
      
      html += `</div>`;
      }
      
      // Generate Mediterranean Diet Handout if checked - on separate page
      if (mediterraneanDiet) {
        html += `<div class="handout-page">`;
        html += `<h1 style="color:#c00;text-align:center;margin-bottom:20px;">Mediterranean Diet Guide</h1>`;
        html += `<div style="max-width:700px;margin:0 auto;padding:20px;line-height:1.8;">`;
        
        html += `<div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid #4caf50;">`;
        html += `<h2 style="color:#2e7d32;margin-top:0;font-size:18px;">What is the Mediterranean Diet?</h2>`;
        html += `<p style="font-size:14px;margin-bottom:0;">The Mediterranean diet is a heart-healthy eating plan based on the traditional foods and cooking styles of countries bordering the Mediterranean Sea. Research has shown that this diet can reduce your risk of heart disease, stroke, and other cardiovascular conditions. It emphasizes whole foods, healthy fats, and plenty of fruits and vegetables.</p>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Foods to Eat Daily</h2>`;
        html += `<div style="margin-bottom:20px;">`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;">ðŸ¥¬ Vegetables (6+ servings daily)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Leafy greens, tomatoes, bell peppers, broccoli, cauliflower, carrots, eggplant, zucchini, onions, and more. Aim for a variety of colors!</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸŽ Fruits (3+ servings daily)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Berries, apples, oranges, grapes, melons, pears, peaches, and other fresh fruits. Limit fruit juices.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸŒ¾ Whole Grains (3-4 servings daily)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Whole wheat bread, brown rice, quinoa, oats, barley, whole grain pasta, and bulgur.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸ¥œ Nuts & Seeds (1 serving daily)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Almonds, walnuts, pistachios, cashews, chia seeds, flaxseeds, and pumpkin seeds. A small handful (about 1 ounce) is a serving.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸ«’ Olive Oil (Primary fat source)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Use extra virgin olive oil for cooking and salad dressings. It's rich in heart-healthy monounsaturated fats.</p>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Foods to Eat Weekly</h2>`;
        html += `<div style="margin-bottom:20px;">`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;">ðŸŸ Fish & Seafood (2-3 times per week)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Salmon, tuna, mackerel, sardines, trout, and other fatty fish are rich in omega-3 fatty acids, which are excellent for heart health.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸ— Poultry (2-3 times per week)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Chicken and turkey (preferably skinless). Choose lean cuts and bake, grill, or roast instead of frying.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸ¥š Eggs (2-4 per week)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Eggs are a good source of protein. You can enjoy them boiled, poached, or scrambled with vegetables.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸ§€ Cheese & Yogurt (Moderate amounts)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Greek yogurt, feta, and other cheeses in moderation. Choose low-fat options when possible.</p>`;
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:15px;">ðŸ· Red Wine (Optional, 1 glass per day)</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">If you drink alcohol, limit to one 5-ounce glass of red wine per day with meals. If you don't drink, you don't need to start.</p>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Foods to Limit or Avoid</h2>`;
        html += `<div style="margin-bottom:20px;">`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li><strong>Red Meat:</strong> Limit to a few times per month. Choose lean cuts when you do eat it.</li>`;
        html += `<li><strong>Processed Foods:</strong> Avoid processed meats (sausages, hot dogs, deli meats), packaged snacks, and fast food.</li>`;
        html += `<li><strong>Refined Grains:</strong> Limit white bread, white rice, and refined pasta. Choose whole grain versions instead.</li>`;
        html += `<li><strong>Added Sugars:</strong> Minimize sweets, desserts, and sugary beverages. Use natural sweeteners like honey or fruit when needed.</li>`;
        html += `<li><strong>Butter & Margarine:</strong> Replace with olive oil for cooking and spreading.</li>`;
        html += `</ul>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Sample Meal Plan</h2>`;
        html += `<div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;">`;
        html += `<h3 style="color:#0066cc;font-size:15px;margin-top:0;">Breakfast</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Greek yogurt with berries and a sprinkle of walnuts, or whole grain toast with avocado and a poached egg.</p>`;
        html += `<h3 style="color:#0066cc;font-size:15px;margin-top:15px;">Lunch</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Mediterranean salad with mixed greens, tomatoes, cucumbers, olives, feta cheese, and grilled chicken, dressed with olive oil and lemon.</p>`;
        html += `<h3 style="color:#0066cc;font-size:15px;margin-top:15px;">Dinner</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Baked salmon with roasted vegetables (broccoli, bell peppers, zucchini) and quinoa, drizzled with olive oil.</p>`;
        html += `<h3 style="color:#0066cc;font-size:15px;margin-top:15px;">Snacks</h3>`;
        html += `<p style="font-size:14px;margin-left:20px;">Fresh fruit, a handful of nuts, or raw vegetables with hummus.</p>`;
        html += `</div>`;
        
        html += `<div style="background:#fff3cd;padding:15px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px;">`;
        html += `<h3 style="color:#856404;margin-top:0;font-size:16px;">ðŸ’¡ Tips for Success</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;margin-bottom:0;">`;
        html += `<li>Start gradually - you don't need to change everything at once</li>`;
        html += `<li>Cook at home more often to control ingredients</li>`;
        html += `<li>Use herbs and spices instead of salt for flavor</li>`;
        html += `<li>Make vegetables the star of your plate</li>`;
        html += `<li>Stay hydrated with water throughout the day</li>`;
        html += `<li>Enjoy meals with family and friends - eating is social!</li>`;
        html += `</ul>`;
        html += `</div>`;
        
        html += `<div style="background:#e3f2fd;padding:15px;border-radius:8px;border-left:5px solid #2196f3;margin-bottom:20px;">`;
        html += `<h3 style="color:#1565c0;margin-top:0;font-size:16px;">â¤ï¸ Heart Health Benefits</h3>`;
        html += `<p style="font-size:14px;margin-bottom:0;">Research shows the Mediterranean diet can help:</p>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;margin-top:8px;margin-bottom:0;">`;
        html += `<li>Lower cholesterol levels</li>`;
        html += `<li>Reduce blood pressure</li>`;
        html += `<li>Decrease risk of heart attack and stroke</li>`;
        html += `<li>Improve blood sugar control</li>`;
        html += `<li>Support healthy weight management</li>`;
        html += `<li>Reduce inflammation in the body</li>`;
        html += `</ul>`;
        html += `</div>`;
        
        html += `<div style="text-align:center;margin-top:30px;padding-top:20px;border-top:2px solid #ddd;font-size:12px;color:#666;">`;
        html += `<p><strong>West Houston Heart Center</strong><br>Dr. Humayun Naqvi, MD, MBA, FACC<br>Phone: 832-271-5897 | <a href="https://www.htxheart.com" style="color:#c00;">www.htxheart.com</a></p>`;
        html += `<p style="margin-top:15px;font-size:11px;">This information is for educational purposes only. Please consult with your healthcare provider before making significant dietary changes.</p>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
      }
      
      // Generate Exercise Regimen Handout if checked - on separate page
      if (exerciseRegimen) {
        html += `<div class="handout-page">`;
        html += `<h1 style="color:#c00;text-align:center;margin-bottom:20px;">Exercise Regimen for Heart Health</h1>`;
        html += `<div style="max-width:700px;margin:0 auto;padding:20px;line-height:1.8;">`;
        
        html += `<div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid #2196f3;">`;
        html += `<h2 style="color:#1565c0;margin-top:0;font-size:18px;">Why Exercise Matters for Your Heart</h2>`;
        html += `<p style="font-size:14px;margin-bottom:0;">Regular physical activity is one of the most important things you can do for your heart health. Exercise strengthens your heart muscle, improves circulation, lowers blood pressure, helps maintain a healthy weight, and reduces stress. This guide will help you create a safe and effective exercise routine tailored for heart health.</p>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Cardiovascular Exercise (Aerobic Activity)</h2>`;
        html += `<div class="content-section" style="margin-bottom:20px;page-break-inside:avoid;">`;
        html += `<p style="font-size:14px;margin-bottom:15px;"><strong>Goal:</strong> Aim for at least 150 minutes of moderate-intensity cardio per week, or 75 minutes of vigorous-intensity cardio per week.</strong></p>`;
        
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;">ðŸƒ Moderate-Intensity Exercises (30-60 minutes, 5 days/week)</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li><strong>Brisk Walking:</strong> Walk at a pace where you can talk but feel slightly breathless. Start with 10-15 minutes and gradually increase to 30-45 minutes.</li>`;
        html += `<li><strong>Cycling:</strong> Stationary bike or outdoor cycling at a moderate pace. Great for low-impact cardio.</li>`;
        html += `<li><strong>Swimming:</strong> Excellent full-body workout that's easy on joints. Aim for continuous swimming or water aerobics.</li>`;
        html += `<li><strong>Elliptical Machine:</strong> Low-impact option that works both upper and lower body.</li>`;
        html += `<li><strong>Dancing:</strong> Fun way to get cardio - try ballroom, line dancing, or Zumba classes.</li>`;
        html += `<li><strong>Rowing:</strong> Full-body workout that's gentle on joints.</li>`;
        html += `</ul>`;
        
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:20px;">âš¡ Vigorous-Intensity Exercises (20-30 minutes, 3 days/week)</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li><strong>Jogging/Running:</strong> Only if cleared by your doctor. Start slow and build gradually.</li>`;
        html += `<li><strong>Fast Cycling:</strong> Increase resistance and speed on stationary bike or outdoor cycling.</li>`;
        html += `<li><strong>Swimming Laps:</strong> Continuous swimming at a faster pace.</li>`;
        html += `<li><strong>High-Intensity Interval Training (HIIT):</strong> Short bursts of intense activity followed by recovery. Example: 30 seconds fast, 60 seconds slow, repeat.</li>`;
        html += `<li><strong>Stair Climbing:</strong> Use stairs or a stair climber machine at a brisk pace.</li>`;
        html += `</ul>`;
        
        html += `<div style="background:#fff3cd;padding:12px;border-radius:6px;margin-top:15px;border-left:4px solid #ffc107;">`;
        html += `<p style="font-size:13px;margin:0;"><strong>ðŸ’¡ How to Know Your Intensity:</strong></p>`;
        html += `<ul style="font-size:13px;line-height:1.6;margin-left:20px;margin-top:8px;margin-bottom:0;">`;
        html += `<li><strong>Moderate:</strong> You can talk but not sing. You feel warm and slightly out of breath.</li>`;
        html += `<li><strong>Vigorous:</strong> You can only say a few words at a time. You're breathing hard and sweating.</li>`;
        html += `</ul>`;
        html += `</div>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Strength Training (Resistance Exercise)</h2>`;
        html += `<div class="content-section" style="margin-bottom:20px;page-break-inside:avoid;">`;
        html += `<p style="font-size:14px;margin-bottom:15px;"><strong>Goal:</strong> Perform strength training exercises 2-3 times per week, with at least one day of rest between sessions.</strong></p>`;
        
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;">ðŸ’ª Upper Body Exercises</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li><strong>Chest Press:</strong> Using resistance bands or light weights, push forward from chest level. 2 sets of 10-15 repetitions.</li>`;
        html += `<li><strong>Bicep Curls:</strong> Hold weights or resistance band, curl arms up. 2 sets of 10-15 repetitions.</li>`;
        html += `<li><strong>Shoulder Raises:</strong> Lift arms to shoulder height to the sides. 2 sets of 10-15 repetitions.</li>`;
        html += `<li><strong>Wall Push-ups:</strong> Stand facing wall, push away. Progress to knee push-ups, then full push-ups. 2 sets of 10-15 repetitions.</li>`;
        html += `<li><strong>Rows:</strong> Pull resistance band or weights toward your body. 2 sets of 10-15 repetitions.</li>`;
        html += `</ul>`;
        
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:20px;">ðŸ¦µ Lower Body Exercises</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li><strong>Squats:</strong> Stand with feet shoulder-width apart, lower as if sitting in a chair. Keep knees behind toes. 2 sets of 10-15 repetitions.</li>`;
        html += `<li><strong>Lunges:</strong> Step forward, lower back knee toward ground. Alternate legs. 2 sets of 10-15 per leg.</li>`;
        html += `<li><strong>Leg Press:</strong> If using a machine, press weight away with legs. 2 sets of 10-15 repetitions.</li>`;
        html += `<li><strong>Calf Raises:</strong> Rise up on toes, lower slowly. 2 sets of 15-20 repetitions.</li>`;
        html += `<li><strong>Glute Bridges:</strong> Lie on back, lift hips up. 2 sets of 15-20 repetitions.</li>`;
        html += `</ul>`;
        
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;margin-top:20px;">ðŸ‹ï¸ Core Strengthening</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li><strong>Planks:</strong> Hold body in straight line, supported on forearms and toes. Start with 10-20 seconds, build to 60 seconds.</li>`;
        html += `<li><strong>Abdominal Crunches:</strong> Lie on back, lift shoulders off ground. 2 sets of 15-20 repetitions.</li>`;
        html += `<li><strong>Dead Bug:</strong> Lie on back, alternate extending opposite arm and leg. 2 sets of 10 per side.</li>`;
        html += `<li><strong>Bird Dog:</strong> On hands and knees, extend opposite arm and leg. 2 sets of 10 per side.</li>`;
        html += `</ul>`;
        
        html += `<div style="background:#e8f5e9;padding:12px;border-radius:6px;margin-top:15px;border-left:4px solid #4caf50;">`;
        html += `<p style="font-size:13px;margin:0;"><strong>âœ… Strength Training Tips:</strong></p>`;
        html += `<ul style="font-size:13px;line-height:1.6;margin-left:20px;margin-top:8px;margin-bottom:0;">`;
        html += `<li>Start with light weights or resistance bands</li>`;
        html += `<li>Focus on proper form over heavy weight</li>`;
        html += `<li>Breathe out during exertion, breathe in during release</li>`;
        html += `<li>Rest 30-60 seconds between sets</li>`;
        html += `<li>Gradually increase weight or resistance as you get stronger</li>`;
        html += `</ul>`;
        html += `</div>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Sample Weekly Exercise Schedule</h2>`;
        html += `<div class="content-section" style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;page-break-inside:avoid;">`;
        html += `<table style="width:100%;border-collapse:collapse;font-size:14px;page-break-inside:avoid;">`;
        html += `<tr style="background:#0066cc;color:white;"><th style="padding:10px;text-align:left;border:1px solid #ddd;">Day</th><th style="padding:10px;text-align:left;border:1px solid #ddd;">Activity</th><th style="padding:10px;text-align:left;border:1px solid #ddd;">Duration</th></tr>`;
        html += `<tr><td style="padding:8px;border:1px solid #ddd;"><strong>Monday</strong></td><td style="padding:8px;border:1px solid #ddd;">Brisk Walk</td><td style="padding:8px;border:1px solid #ddd;">30-45 min</td></tr>`;
        html += `<tr style="background:#f9f9f9;"><td style="padding:8px;border:1px solid #ddd;"><strong>Tuesday</strong></td><td style="padding:8px;border:1px solid #ddd;">Strength Training (Full Body)</td><td style="padding:8px;border:1px solid #ddd;">20-30 min</td></tr>`;
        html += `<tr><td style="padding:8px;border:1px solid #ddd;"><strong>Wednesday</strong></td><td style="padding:8px;border:1px solid #ddd;">Swimming or Cycling</td><td style="padding:8px;border:1px solid #ddd;">30-45 min</td></tr>`;
        html += `<tr style="background:#f9f9f9;"><td style="padding:8px;border:1px solid #ddd;"><strong>Thursday</strong></td><td style="padding:8px;border:1px solid #ddd;">Rest or Light Stretching</td><td style="padding:8px;border:1px solid #ddd;">-</td></tr>`;
        html += `<tr><td style="padding:8px;border:1px solid #ddd;"><strong>Friday</strong></td><td style="padding:8px;border:1px solid #ddd;">Brisk Walk or Elliptical</td><td style="padding:8px;border:1px solid #ddd;">30-45 min</td></tr>`;
        html += `<tr style="background:#f9f9f9;"><td style="padding:8px;border:1px solid #ddd;"><strong>Saturday</strong></td><td style="padding:8px;border:1px solid #ddd;">Strength Training (Full Body)</td><td style="padding:8px;border:1px solid #ddd;">20-30 min</td></tr>`;
        html += `<tr><td style="padding:8px;border:1px solid #ddd;"><strong>Sunday</strong></td><td style="padding:8px;border:1px solid #ddd;">Active Recovery (Gentle walk, yoga, or rest)</td><td style="padding:8px;border:1px solid #ddd;">20-30 min</td></tr>`;
        html += `</table>`;
        html += `</div>`;
        
        html += `<p style="font-size:14px;line-height:1.6;margin-top:20px;margin-bottom:20px;color:#555;">Use the schedule above as a starting point and adjust it based on your fitness level, schedule, and doctor's recommendations. Remember, consistency is more important than intensity - even small amounts of regular exercise provide significant heart health benefits.</p>`;
        
        html += `<div style="page-break-before: always;"></div>`;
        html += `<div class="content-section" style="page-break-inside:avoid;margin-bottom:20px;">`;
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:0;">Patient Accountability Guide</h2>`;
        html += `<div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid #ffc107;page-break-inside:avoid;">`;
        html += `<h3 style="color:#856404;margin-top:0;font-size:16px;">ðŸ“‹ Weekly Exercise Log</h3>`;
        html += `<p style="font-size:14px;margin-bottom:15px;">Use this log to track your exercise and stay accountable. Bring it to your follow-up appointments.</p>`;
        html += `<table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:15px;page-break-inside:avoid;">`;
        html += `<tr style="background:#0066cc;color:white;"><th style="padding:8px;text-align:left;border:1px solid #ddd;">Date</th><th style="padding:8px;text-align:left;border:1px solid #ddd;">Type of Exercise</th><th style="padding:8px;text-align:left;border:1px solid #ddd;">Duration</th><th style="padding:8px;text-align:left;border:1px solid #ddd;">Intensity</th><th style="padding:8px;text-align:left;border:1px solid #ddd;">Notes</th></tr>`;
        for (let i = 0; i < 7; i++) {
          html += `<tr><td style="padding:6px;border:1px solid #ddd;">&nbsp;</td><td style="padding:6px;border:1px solid #ddd;">&nbsp;</td><td style="padding:6px;border:1px solid #ddd;">&nbsp;</td><td style="padding:6px;border:1px solid #ddd;">&nbsp;</td><td style="padding:6px;border:1px solid #ddd;">&nbsp;</td></tr>`;
        }
        html += `</table>`;
        html += `<div style="page-break-inside:avoid;">`;
        html += `<p style="font-size:13px;margin-bottom:0;"><strong>Weekly Goal:</strong> Check off your goals as you achieve them:</p>`;
        html += `<ul style="font-size:13px;line-height:1.8;margin-left:20px;margin-top:8px;margin-bottom:0;page-break-inside:avoid;">`;
        html += `<li>â˜ Completed 150+ minutes of moderate cardio OR 75+ minutes of vigorous cardio</li>`;
        html += `<li>â˜ Completed 2-3 strength training sessions</li>`;
        html += `<li>â˜ Stayed active 5+ days this week</li>`;
        html += `<li>â˜ Drank plenty of water during and after exercise</li>`;
        html += `<li>â˜ Listened to my body and rested when needed</li>`;
        html += `</ul>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Safety Guidelines & Warning Signs</h2>`;
        html += `<div class="content-section" style="margin-bottom:20px;page-break-inside:avoid;">`;
        html += `<div class="content-section" style="background:#ffebee;padding:15px;border-radius:8px;border-left:5px solid #f44336;margin-bottom:15px;page-break-inside:avoid;">`;
        html += `<h3 style="color:#c62828;margin-top:0;font-size:16px;">âš ï¸ Stop Exercising Immediately If You Experience:</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;margin-bottom:0;">`;
        html += `<li>Chest pain or pressure</li>`;
        html += `<li>Severe shortness of breath</li>`;
        html += `<li>Dizziness or lightheadedness</li>`;
        html += `<li>Irregular heartbeat or palpitations</li>`;
        html += `<li>Nausea or excessive fatigue</li>`;
        html += `<li>Pain in your arms, neck, jaw, or back</li>`;
        html += `<li>If symptoms persist, seek medical attention immediately</li>`;
        html += `</ul>`;
        html += `</div>`;
        
        html += `<h3 style="color:#0066cc;font-size:16px;margin-bottom:8px;">âœ… Before You Start:</h3>`;
        html += `<ul style="font-size:14px;line-height:1.8;margin-left:20px;">`;
        html += `<li>Always warm up for 5-10 minutes before exercise (light walking, arm circles)</li>`;
        html += `<li>Cool down for 5-10 minutes after exercise (gentle stretching, slow walking)</li>`;
        html += `<li>Stay hydrated - drink water before, during, and after exercise</li>`;
        html += `<li>Wear comfortable, supportive shoes and clothing</li>`;
        html += `<li>Start slowly and gradually increase intensity and duration</li>`;
        html += `<li>If you're new to exercise or have health concerns, consult with your doctor first</li>`;
        html += `</ul>`;
        html += `</div>`;
        
        html += `<h2 style="color:#c00;border-bottom:2px solid #c00;padding-bottom:8px;margin-top:25px;">Progression Plan</h2>`;
        html += `<div class="content-section" style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid #4caf50;page-break-inside:avoid;">`;
        html += `<h3 style="color:#2e7d32;margin-top:0;font-size:16px;">ðŸ“ˆ Building Your Fitness Gradually</h3>`;
        html += `<p style="font-size:14px;margin-bottom:12px;"><strong>Week 1-2 (Getting Started):</strong></p>`;
        html += `<ul style="font-size:13px;line-height:1.6;margin-left:20px;margin-bottom:12px;">`;
        html += `<li>Cardio: 10-15 minutes, 3-4 days per week</li>`;
        html += `<li>Strength: 1 session per week, light weights or body weight only</li>`;
        html += `<li>Focus on establishing the habit</li>`;
        html += `</ul>`;
        html += `<p style="font-size:14px;margin-bottom:12px;"><strong>Week 3-4 (Building):</strong></p>`;
        html += `<ul style="font-size:13px;line-height:1.6;margin-left:20px;margin-bottom:12px;">`;
        html += `<li>Cardio: 20-30 minutes, 4-5 days per week</li>`;
        html += `<li>Strength: 2 sessions per week</li>`;
        html += `<li>Gradually increase intensity</li>`;
        html += `</ul>`;
        html += `<p style="font-size:14px;margin-bottom:12px;"><strong>Week 5+ (Maintaining):</strong></p>`;
        html += `<ul style="font-size:13px;line-height:1.6;margin-left:20px;margin-bottom:0;">`;
        html += `<li>Cardio: 30-45 minutes, 5 days per week</li>`;
        html += `<li>Strength: 2-3 sessions per week</li>`;
        html += `<li>Continue challenging yourself while listening to your body</li>`;
        html += `</ul>`;
        html += `</div>`;
        
        html += `<div style="text-align:center;margin-top:30px;padding-top:20px;border-top:2px solid #ddd;font-size:12px;color:#666;">`;
        html += `<p><strong>West Houston Heart Center</strong><br>Dr. Humayun Naqvi, MD, MBA, FACC<br>Phone: 832-271-5897 | <a href="https://www.htxheart.com" style="color:#c00;">www.htxheart.com</a></p>`;
        html += `<p style="margin-top:15px;font-size:11px;">This information is for educational purposes only. Always consult with your healthcare provider before starting a new exercise program, especially if you have heart conditions, high blood pressure, or other health concerns.</p>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
      }
      
      html += `</body></html>`;
      pw.document.write(html);
      pw.document.close();
      pw.focus();
      pw.print();
      
      // Clear form
      document.getElementById('order-form').reset();
      document.getElementById('dos').value = dosValue;
      initAdminForm();
    });
    
    // Initialize app
    initUsers();
    showView();
  </script>
</body>
</html>
